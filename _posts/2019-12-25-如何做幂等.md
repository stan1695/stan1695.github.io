---
title: 如何做幂等
categories:
 - 中间件
tags: 幂等
---

* 1、接口的幂等是一个很复杂的操作。不是所有的接口都需要做幂等，幂等会带来接口的复杂度。接口的主要功能还是业务操作，如果能够将接口的幂等抽离接口，这是最好的方案。
* 2、用java同步锁可以简单的做接口的幂等，但是在多服务节点的情况下，无效。
* 3、java分布式锁（比如redis分布式锁），可以做接口幂等。但是redis分布式锁比较复杂，比如：redis锁的超时时间控制多少合适，还要注意redis解锁，要不然容易造成死锁，redis挂了怎么办。
* 4、锁的方式是在出现高并发的情况下可以控制接口的幂等性。
* 5、利用数据库的唯一索引来做幂等，为了给前台友好显示，我们可以先查询数据库中是否存在，再判断是否往下进行业务处理。（mysql中有新的脚本支持判断）  

    ```
    insert IGNORE:插入的数据判断主键是否存在，唯一索引的数据是否存在，如果两个有一个存在，则不插入，也不报错。
    insert into:插入的数据判断主键是否存在，唯一索引的数据是否存在，如果两个有一个存在，则报错。
    REPLACE into：插入的数据判断主键是否存在，唯一索引的数据是否存在，如果两个有一个存在，则删除原来的，新增插入的。

    INSERT INTO ... ON DUPLICATE KEY UPDATE ...(主键或唯一索引没有就插入，有就更新)
    ```
* 6、利用数据库中的业务数据的唯一性做幂等。
* 7、相对于在业务表面上做唯一索引，更推荐独立出一个表token_table排重表或者令牌表。表中主要字段是unique_key，并在unique_key上建立唯一索引。